# Android移植文档

## 项目概述

xiaoniao Android版本是基于Go语言和Fyne框架开发的剪贴板翻译工具，保持了与桌面版核心功能的一致性，同时针对移动平台进行了优化。

## 技术方案

### 框架选择：Fyne

选择Fyne框架的原因：
1. **纯Go开发**：无需学习新语言，代码复用率高
2. **原生性能**：不是WebView，真正的原生渲染
3. **跨平台统一**：同一套代码可编译多平台
4. **简单易用**：API设计简洁，学习成本低

### 核心技术栈

- **编程语言**：Go 1.21+
- **GUI框架**：Fyne v2.4+
- **剪贴板监听**：Android AccessibilityService
- **API通信**：复用现有HTTP客户端
- **国际化**：复用现有i18n模块

## UI设计规范

### 设计理念：水墨风格

- **配色方案**：黑白灰为主，小鸟图标保持彩色
- **布局原则**：大量留白，重点突出
- **交互方式**：底部导航，简洁直观

### 颜色定义

```go
// 水墨风配色
inkBlack     = color.NRGBA{R: 28, G: 28, B: 28, A: 255}    // 墨黑
paperWhite   = color.NRGBA{R: 245, G: 245, B: 240, A: 255} // 宣纸白
ink90        = color.NRGBA{R: 40, G: 40, B: 40, A: 230}    // 浓墨
ink70        = color.NRGBA{R: 60, G: 60, B: 60, A: 180}    // 中墨
ink50        = color.NRGBA{R: 100, G: 100, B: 100, A: 130} // 淡墨
ink30        = color.NRGBA{R: 150, G: 150, B: 150, A: 80}  // 轻墨

// 小鸟图标状态色
birdBlue     = color.NRGBA{R: 30, G: 144, B: 255, A: 255}  // 正常
birdGreen    = color.NRGBA{R: 50, G: 205, B: 50, A: 255}   // 翻译中
birdRed      = color.NRGBA{R: 255, G: 69, B: 0, A: 255}    // 错误
```

## UI布局设计图

### 1. 主框架结构

```
┌──────────────────────────────────┐
│  状态栏（系统）                   │
├──────────────────────────────────┤
│                                  │
│        内容区域                  │
│        (根据底部导航切换)        │
│                                  │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │ 56dp高度
│   ●                              │ 选中指示器
└──────────────────────────────────┘
```

### 2. 状态分区 - 主界面

```
┌──────────────────────────────────┐
│  xiaoniao - 状态                 │
├──────────────────────────────────┤
│                                  │
│  ┌────────────────────────────┐ │
│  │  监控状态：● 运行中         │ │
│  │  当前模型：GPT-4o-mini      │ │
│  │  当前提示词：简洁翻译       │ │
│  │  界面语言：简体中文 ▼       │ │
│  │  今日翻译：42 次            │ │
│  └────────────────────────────┘ │
│                                  │
│  ┌────────────────────────────┐ │
│  │  [开始监控]  [停止监控]     │ │
│  └────────────────────────────┘ │
│                                  │
│  ┌────────────────────────────┐ │
│  │  快速测试                   │ │
│  │  ┌────────────────────┐    │ │
│  │  │ 输入要翻译的文本... │    │ │
│  │  └────────────────────┘    │ │
│  │  [翻译]                     │ │
│  │  ┌────────────────────┐    │ │
│  │  │ 翻译结果...         │    │ │
│  │  └────────────────────┘    │ │
│  └────────────────────────────┘ │
│                                  │
│  [查看日志]                      │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│   ●                              │
└──────────────────────────────────┘
```

### 3. 状态分区 - 日志查看

```
┌──────────────────────────────────┐
│  < 返回  日志                    │
├──────────────────────────────────┤
│  ┌────────────────────────────┐ │
│  │ 2025-01-19 10:23:15        │ │
│  │ [INFO] 翻译服务已启动       │ │
│  │                            │ │
│  │ 2025-01-19 10:23:20        │ │
│  │ [INFO] 检测到剪贴板变化     │ │
│  │ 原文: Hello World          │ │
│  │ 译文: 你好世界             │ │
│  │                            │ │
│  │ 2025-01-19 10:23:25        │ │
│  │ [ERROR] API调用失败         │ │
│  │ 错误: 网络超时             │ │
│  │ ...                        │ │
│  └────────────────────────────┘ │
│                                  │
│  [清空日志]  [导出日志]          │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│   ●                              │
└──────────────────────────────────┘
```

### 4. 设置分区 - 主界面

```
┌──────────────────────────────────┐
│  设置                            │
├──────────────────────────────────┤
│                                  │
│  ┌────────────────────────────┐ │
│  │  > API和模型配置            │ │
│  │    管理API密钥和选择模型    │ │
│  ├────────────────────────────┤ │
│  │  > 提示词管理               │ │
│  │    自定义翻译提示词         │ │
│  ├────────────────────────────┤ │
│  │  > 快捷操作                 │ │
│  │    无障碍服务设置           │ │
│  ├────────────────────────────┤ │
│  │  > 使用教程                 │ │
│  │    了解如何使用本应用       │ │
│  └────────────────────────────┘ │
│                                  │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│        ●                         │
└──────────────────────────────────┘
```

### 5. 设置分区 - API配置

```
┌──────────────────────────────────┐
│  < 返回  API配置                 │
├──────────────────────────────────┤
│                                  │
│  API密钥                         │
│  ┌────────────────────────────┐ │
│  │  请输入API密钥...           │ │
│  └────────────────────────────┘ │
│                                  │
│  提供商：自动检测                │
│  ┌────────────────────────────┐ │
│  │  系统将根据API密钥格式      │ │
│  │  自动识别提供商：           │ │
│  │  • sk-... → OpenAI         │ │
│  │  • gsk_... → Groq          │ │
│  │  • 其他格式自动匹配         │ │
│  └────────────────────────────┘ │
│                                  │
│  选择模型                        │
│  ┌────────────────────────────┐ │
│  │  ○ gpt-4o                 │ │
│  │  ● gpt-4o-mini            │ │
│  │  ○ gpt-3.5-turbo          │ │
│  │  （模型列表根据API自动加载） │ │
│  └────────────────────────────┘ │
│                                  │
│  [测试连接]  [保存]              │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│        ●                         │
└──────────────────────────────────┘
```

### 6. 设置分区 - 提示词管理

```
┌──────────────────────────────────┐
│  < 返回  提示词管理              │
├──────────────────────────────────┤
│  当前提示词                      │
│  ┌────────────────────────────┐ │
│  │  ○ 简洁翻译                │ │
│  │  ● 详细翻译                │ │
│  │  ○ 技术文档                │ │
│  │  ○ 口语化                  │ │
│  │  + 添加自定义               │ │
│  └────────────────────────────┘ │
│                                  │
│  编辑提示词                      │
│  ┌────────────────────────────┐ │
│  │ 名称: 详细翻译             │ │
│  ├────────────────────────────┤ │
│  │ 你是专业翻译，请将以下    │ │
│  │ 内容翻译成中文，保留      │ │
│  │ 原文格式...               │ │
│  └────────────────────────────┘ │
│                                  │
│  [删除] [保存修改]               │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│        ●                         │
└──────────────────────────────────┘
```

### 7. 设置分区 - 快捷操作

```
┌──────────────────────────────────┐
│  < 返回  快捷操作设置            │
├──────────────────────────────────┤
│                                  │
│  无障碍服务                      │
│  ┌────────────────────────────┐ │
│  │                            │ │
│  │  剪贴板监控    [开关]      │ │
│  │  自动粘贴      [开关]      │ │
│  │                            │ │
│  │  需要开启无障碍权限才能    │ │
│  │  使用自动翻译功能          │ │
│  │                            │ │
│  │  [前往系统设置]           │ │
│  │                            │ │
│  └────────────────────────────┘ │
│                                  │
│  通知设置                        │
│  ┌────────────────────────────┐ │
│  │                            │ │
│  │  显示翻译通知   [开关]      │ │
│  │  翻译完成提示音  [开关]      │ │
│  │                            │ │
│  └────────────────────────────┘ │
│                                  │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│        ●                         │
└──────────────────────────────────┘
```

### 8. 设置分区 - 使用教程

```
┌──────────────────────────────────┐
│  < 返回  使用教程                │
├──────────────────────────────────┤
│                                  │
│  ┌────────────────────────────┐ │
│  │  1. 基础设置                │ │
│  │  首次使用需要：             │ │
│  │  • 配置API密钥              │ │
│  │  • 选择翻译模型             │ │
│  │  • 授予无障碍权限           │ │
│  │                            │ │
│  │  2. 使用方法                │ │
│  │  • 复制任意文本             │ │
│  │  • 自动检测并翻译           │ │
│  │  • 自动粘贴译文             │ │
│  │                            │ │
│  │  3. 高级功能                │ │
│  │  • 自定义提示词             │ │
│  │  • 通知设置                │ │
│  │                            │ │
│  │  [查看完整文档]            │ │
│  └────────────────────────────┘ │
│                                  │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│        ●                         │
└──────────────────────────────────┘
```

### 9. 支持作者分区

```
┌──────────────────────────────────┐
│  关于 xiaoniao                   │
├──────────────────────────────────┤
│                                  │
│        [小鸟图标]                │
│                                  │
│       xiaoniao Android           │
│        版本 v1.0.0               │
│                                  │
│  ────────────────────────        │
│                                  │
│        作者：梨梨果              │
│                                  │
│   一个简洁高效的剪贴板翻译工具   │
│   支持20+AI提供商和300+模型      │
│                                  │
│  ────────────────────────        │
│                                  │
│  项目地址：                      │
│  github.com/username/xiaoniao    │
│                                  │
│  [访问GitHub] [检查更新]         │
│                                  │
│  ────────────────────────        │
│                                  │
│  如果觉得好用，欢迎在GitHub      │
│  给项目Star或赞助支持开发        │
│                                  │
│  [查看赞助方式]                  │
│                                  │
├──────────────────────────────────┤
│  [鸟] [齿轮] [咖啡]              │
│              ●                   │
└──────────────────────────────────┘
```

## 无障碍服务集成

### 实现方案

1. **创建AccessibilityService**
   - 监听TYPE_VIEW_TEXT_SELECTION_CHANGED事件
   - 检测剪贴板变化
   - 实现自动粘贴

2. **JNI桥接**
```c
// internal/accessibility/jni_bridge.c
JNIEXPORT void JNICALL
Java_com_liliguo_xiaoniao_AccessibilityService_onClipboardChanged(
    JNIEnv *env, jobject thiz, jstring text) {
    // 调用Go函数处理剪贴板文本
}
```

3. **权限申请流程**
   - 检测无障碍服务状态
   - 引导用户到系统设置
   - 提供清晰的操作指引

## 构建流程

### 环境准备

```bash
# 安装Fyne CLI
go install fyne.io/fyne/v2/cmd/fyne@latest

# 配置Android环境
export ANDROID_HOME=$HOME/Android/Sdk
export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
```

### 构建命令

```bash
# 进入项目目录
cd xiaoniao_android

# 构建APK
fyne package -os android \
  -appID com.liliguo.xiaoniao \
  -name xiaoniao \
  -release
```

### 签名发布

```bash
# 生成签名密钥
keytool -genkey -v -keystore xiaoniao.keystore \
  -alias xiaoniao -keyalg RSA -keysize 2048 \
  -validity 10000

# 签名APK
jarsigner -verbose -sigalg SHA1withRSA \
  -digestalg SHA1 -keystore xiaoniao.keystore \
  xiaoniao.apk xiaoniao
```

## 代码复用策略

### 可直接复用模块（95%）
- `internal/translator/*` - 翻译引擎
- `internal/i18n/*` - 国际化
- `internal/logbuffer/*` - 日志缓冲

### 需要适配模块（5%）
- 剪贴板监听 - Android特定实现
- UI界面 - Fyne框架重写
- 配置存储路径 - Android内部存储

## 性能优化

### 内存优化
- 使用对象池减少GC
- 及时释放不用的资源
- 控制日志缓冲区大小

### 电池优化
- 合理使用前台服务
- 避免频繁轮询
- 使用系统回调代替定时器

### 网络优化
- 复用HTTP连接
- 实现请求缓存
- 失败重试机制

## 测试计划

### 功能测试
- [x] 剪贴板监听
- [x] 翻译功能
- [x] 自动粘贴
- [x] 多语言切换
- [x] 提示词管理

### 兼容性测试
- Android 5.0 (API 21)
- Android 14 (API 34)
- 不同屏幕尺寸
- 不同厂商ROM

### 性能测试
- 内存占用 < 80MB
- CPU使用率 < 2%
- 响应时间 < 100ms
- 电池消耗合理

## 发布计划

### v1.0.0 (2025-01)
- 基础翻译功能
- 无障碍服务支持
- 水墨风UI界面
- 多语言支持

### v1.1.0 (计划)
- 翻译历史记录
- 离线提示词同步
- 更多API提供商

## 常见问题

### Q: 为什么需要无障碍权限？
A: 用于监听剪贴板变化和实现自动粘贴功能。

### Q: 支持哪些Android版本？
A: Android 5.0（API 21）及以上版本。

### Q: APK文件有多大？
A: 约15-20MB，包含所有依赖。

### Q: 是否支持平板？
A: 支持，UI会自适应屏幕尺寸。

## 作者

梨梨果

## 许可证

MIT License

---

最后更新：2025-01-19